# When will it happen?

So the question you may be asking is _when_ will this happen? When does storing a value in an interface qualify for not needing a memory allocation on the heap? Well, there are a few criteria:

* Zero values, including `0`, `nil`, and an empty string `""` all qualify.
* Any value that is type which is a single byte wide, such as `bool`, `int8`, and `uint8`.
* Any integer type with a value that is in the inclusive range of 0-255.
* Some structs with a single field that follows the above rules are also subject to this special behavior, but not always. 

In order to produce a more comprehensive dataset for when this behavior _could_ occur, we can run the following command:

```bash
docker run -it --rm go-interface-values:latest \
  bash -c 'cd ./tests/mem && \
  go tool compile -S -wb=false *.go | \
  python3 ../../hack/asm2md.py --no-echo'
```

The output will be a markdown table that indicates the assembly instruction used to store each of the following types, both their zero and non-zero values, in an interface. Some notes about the following information:

* The table was generated on a linux/amd64 system.
* The functions to store the zero and non-zero values are the same for both assembly and Go, but I had already written the parser to figure out both, so I kept them in.
* For some types Go uses the same conversion function for `T` and `struct{a T}`, including:
    * `int`, `int16`, `int32`, `int64`
    * `uint`, `uint16`, `uint32`, `uint64`
    * `float32`, `float64`
    * `rune` (which has an underlying type of `int32`)
    * `string` and `struct{a string}`

    This means if Go has an optimization for `T` in the above list, the same optimization applies to `struct{a T}`.
* Strangely this behavior does _not_ extend to `struct{a T}` when `T` is `bool`, `int8`, or `uint8`, all single-byte wide values.

| Type | Line no | Op to store zero value in asm | ...in go | Op to store non-zero, random value in asm | ...in go |
|:----:|:-------:|:-----------------------------:|:--------:|:-----------------------------------------:|:--------:|
| `int` | 32 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `int8` | 60 | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) |
| `int16` | 88 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) |
| `int32` | 116 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `int64` | 144 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `uint` | 172 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `uint8` | 200 | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) |
| `uint16` | 228 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) |
| `uint32` | 256 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `uint64` | 284 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `float32` | 312 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `float64` | 340 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `complex64` | 368 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `complex128` | 396 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `byte` | 424 | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) |
| `bool` | 452 | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) | [LEAQ](https://www.felixcloutier.com/x86/lea) | [runtime.staticuint64s](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L492-L526) |
| `rune` | 480 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `string` | 508 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTstring](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L388-L396) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTstring](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L388-L396) |
| `struct_int` | 536 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `struct_int8` | 564 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_int16` | 592 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) |
| `struct_int32` | 620 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `struct_int64` | 648 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `struct_uint` | 676 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `struct_uint8` | 704 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_uint16` | 732 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT16](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L352-L363) |
| `struct_uint32` | 760 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `struct_uint64` | 788 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `struct_float32` | 816 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `struct_float64` | 844 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT64](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L378-L386) |
| `struct_complex64` | 872 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_complex128` | 900 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_byte` | 928 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_bool` | 956 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_rune` | 984 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convT32](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L365-L376) |
| `struct_string` | 1012 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTstring](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L388-L396) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTstring](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L388-L396) |
| `struct_int32_int32` | 1040 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_int32_int64` | 1068 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_array_bytes_7` | 1096 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |
| `struct_byte_7` | 1124 | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) | [CALL](https://www.felixcloutier.com/x86/call) | [runtime.convTnoptr](https://github.com/golang/go/blob/41f485b9a7d8fd647c415be1d11b612063dff21c/src/runtime/iface.go#L335-L350) |


Okay, now we know what each function is used when storing specific types in interfaces, but we don't have a clear picture of when those functions malloc and when they do not. Well, _I_ have a clear idea, and you will too once you click to the next page :smiley:

---

Next: [Overall impact](./04-what.md)
